---
title: ガイド付き最適化のプロファイル
ms.date: 04/23/2019
helpviewer_keywords:
- profile-guided optimizations
- optimization, profile-guided [C++]
ms.assetid: 2225c307-d3ae-42c1-8345-a5a959d132dc
ms.openlocfilehash: 062f8fb8138446e4a00ba6501d6eeb8571625749
ms.sourcegitcommit: 2d7550d0f375aafa428ef0fb2e3962e4232be28e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/15/2020
ms.locfileid: "84777319"
---
# <a name="profile-guided-optimizations"></a>ガイド付き最適化のプロファイル

ガイド付き最適化のプロファイル (PGO) では、実行可能ファイル全体を最適化できます。この場合、オプティマイザーは .exe ファイルまたは .dll ファイルのテスト実行データを使用します。 データは、運用環境で予想されるプログラムのパフォーマンスを表します。

ガイド付き最適化のプロファイルは x86 または x64 のネイティブ ターゲットにのみ使用できます。 ガイド付き最適化のプロファイルは、共通言語ランタイムで実行する実行可能ファイルでは使用できません。 ネイティブ コードとマネージド コードが混在するアセンブリを生成した場合でも ( **/clr** コンパイラ オプションを使用)、ネイティブ コードのみでプロファイル ガイド付き最適化を使用することはできません。 IDE でこれらのオプション セットを使用してプロジェクトのビルドを試みると、結果としてビルド エラーが発生します。

> [!NOTE]
> プロファイル テストの実行から収集された情報は、 **/Ob**、 **/Os**、または **/Ot** を指定した場合に有効になる最適化をオーバーライドします。 詳細については、「[/Ob (関数のインライン展開)](reference/ob-inline-function-expansion.md)」および「[/Os、/Ot (実行可能ファイルのサイズの優先、実行速度の優先)](reference/os-ot-favor-small-code-favor-fast-code.md)」を参照してください。

## <a name="steps-to-optimize-your-app"></a>アプリを最適化する手順

ガイド付き最適化のプロファイルを使用するには、次の手順に従ってアプリを最適化します。

- [/GL](reference/gl-whole-program-optimization.md) を指定して、1 つ以上のソース コード ファイルをコンパイルします。

   ガイド付き最適化のプロファイルテストの実行中、 **/GL** を指定して構築された各モジュールを調べて、実行時の動作をキャプチャすることができます。 ガイド付き最適化のプロファイル ビルド内のすべてのモジュールを、 **/GL** を指定してコンパイルする必要はありません。 ただし、インストルメント化され、後でガイド付き最適化に使用できるのは、 **/GL** を指定してコンパイルされたモジュールだけです。

- [/LTCG](reference/ltcg-link-time-code-generation.md) および [/GENPROFILE または /FASTGENPROFILE](reference/genprofile-fastgenprofile-generate-profiling-instrumented-build.md) を使用してリンクします。

   **/LTCG** と **/GENPROFILE** または **/FASTGENPROFILE** の両方を使用すると、インストルメント化されたアプリを実行するときに `.pgd` ファイルが作成されます。 テスト実行用のデータを `.pgd` ファイルに追加すると、次のリンクの手順 (最適化されたイメージの作成) の入力として使用できます。 **/GENPROFILE** を指定した場合、必要に応じて **PGD=** "_ファイル名_" 引数を追加することにより、`.pgd` ファイルの既定以外の名前または場所を指定できます。 **/LTCG** リンカー オプションと **/GENPROFILE** または **/FASTGENPROFILE** リンカー オプションの組み合わせは、非推奨の **/LTCG:PGINSTRUMENT** リンカー オプションの代わりに使用します。

- アプリケーションのプロファイリングを行います。

   プロファイルされた EXE セッションが終了するたび、またはプロファイルされた DLL がアンロードされるたびに、`appname!N.pgc` ファイルが作成されます。 `.pgc` ファイルには、特定のアプリケーションのテスト実行に関する情報が含まれます。 *appname* はアプリの名前で、*N* は数字で、ディレクトリ内にある他の `appname!N.pgc` ファイルの数に基づいて 1 から順に増分されます。 テスト実行の結果が目的の最適化のシナリオを示さない場合は、`.pgc` ファイルを削除できます。

   テストの実行中に、現在開かれている `.pgc` ファイルを強制的に閉じて、[pgosweep](pgosweep.md) ユーティリティを使用して新しい `.pgc` ファイルを作成できます (たとえば、テスト シナリオの終了がアプリケーションのシャットダウンと同時ではない場合など)。

   アプリケーションで PGO 関数 [PgoAutoSweep](pgoautosweep.md) を直接呼び出して、呼び出しの時点のプロファイル データを `.pgc` ファイルとしてキャプチャすることもできます。 これにより、`.pgc` ファイル内のキャプチャされたデータの対象となるコードをより細かく制御できるようになります。 この関数の使用方法を示す例については、[PgoAutoSweep](pgoautosweep.md) のドキュメントを参照してください。

   インストルメント化されたビルドを作成する場合、既定では、データ収集は、非スレッドセーフ モードで実行されます。これは高速ですが、不正確な場合があります。 **/GENPROFILE** または **/FASTGENPROFILE** に **EXACT** 引数を使用すると、スレッドセーフ モードでのデータ収集を指定できます。その場合、精度は高くなりますが、速度は低下します。 このオプションは、インストルメント化されたビルドを作成するときに、非推奨の [PogoSafeMode](environment-variables-for-profile-guided-optimizations.md#pogosafemode) 環境変数または非推奨の **/POGOSAFEMODE** リンカー オプションを設定する場合にも使用できます。

- **/LTCG** と **/USEPROFILE** を使用してリンクします。

   **/LTCG** リンカー オプションと [/USEPROFILE](reference/useprofile.md) リンカー オプションの両方を使用して、最適化されたイメージを作成します。 この手順は、`.pgd` ファイルの入力として使用します。 **/USEPROFILE** を指定した場合、必要に応じて **PGD=** "_ファイル名_" 引数を追加することにより、`.pgd` ファイルの既定以外の名前または場所を指定できます。 また、非推奨の **/PGD** リンカー オプションを使用して、この名前を指定することもできます。 **/LTCG** と **/USEPROFILE**の組み合わせは、非推奨の **/LTCG:PGOPTIMIZE** リンカー オプションおよび **/LTCG:PGUPDATE** リンカー オプションの代わりに使用します。

最適化された実行可能ファイルを作成し、追加のプロファイルによりさらに最適化されたイメージを作成できるかどうかを後で判断することもできます。 インストルメント化されたイメージとその `.pgd` ファイルが使用可能な場合、追加のテスト実行を行い、同じ **/LTCG** リンカー オプションと **/USEPROFILE** リンカー オプションを使用して、新しい `.pgd` ファイルで最適化されたイメージを再構築できます。

> [!NOTE]
> `.pgc` および `.pgd` ファイルの種類はどちらも、バイナリ ファイルです。 ソース管理システムに格納されている場合は、テキスト ファイルに対して行われる可能性のある自動変換を回避します。

## <a name="optimizations-performed-by-pgo"></a>PGO で実行される最適化

ガイド付き最適化のプロファイルには、次のチェックと改善が含まれます。

- **インライン展開** - たとえば、関数 A が関数 B を頻繁に呼び出し、関数 B が比較的小さい場合、ガイド付き最適化のプロファイルにより、関数 B が関数 A にインライン展開されます。

- **仮想呼び出し推理** - 仮想呼び出し、または関数ポインターからのその他の呼び出しが特定の関数を頻繁に呼び出す場合、ガイド付き最適化のプロファイルにより、頻繁に呼び出される関数に条件付きで実行される直接呼び出しを挿入し、その直接呼び出しをインライン展開できます。

- **レジスタ割り当て** - プロファイル データに基づいた最適化により、レジスタの割り当てが改善されます。

- **基本ブロックの最適化** - 基本ブロックの最適化を行うと、一般的に実行され、特定のフレーム内で一時的に実行される基本ブロックを同じページ セット (ローカリティ) に配置できます。 これにより、使用されるページ数が最小限に抑えられるため、メモリのオーバーヘッドも最小限に抑えられます。

- **サイズ/速度の最適化** - プログラムで最も多くの実行時間が費やされる関数の速度を最適化できます。

- **関数のレイアウト** - コールグラフおよびプロファイルされた呼び出し元/呼び出し先の動作に基づいて、同じ実行パスになる傾向のある関数が同じセクション内に配置されます。

- **条件付き分岐の最適化** - ガイド付き最適化のプロファイルにより、値プローブを使用して、switch ステートメント内の特定の値が他の値よりも頻繁に使用されているかどうかを確認できます。  この値は switch ステートメントから取得できます。  同じことを `if`...`else` 命令でも行うことができます。この場合、オプティマイザーは、`if`...`else`を順序付けることができるため、`if` ブロックまたは `else` ブロックのどちらがより頻繁に true になるかに応じて、いずれかのブロックが先に配置されます。

- **実行されないコードの分離** - プロファイルの実行中に呼び出されないコードを、一連のセクションの最後に追加される特別なセクションに移動します。 これにより、頻繁に使用されるページからこのセクションが切り離されます。

- **EH コードの分離** - EH コードは例外的に実行されるだけなので、多くの場合、個別のセクションに移動できます。 これは、ガイド付き最適化のプロファイルで例外が例外的な条件でのみ発生すると判断できる場合に移動されます。

- **メモリの組み込み** - 組み込みを拡張するかどうかは、頻繁に呼び出されるかどうかによって異なります。 また、組み込みは、移動またはコピーのブロック サイズに基づいて最適化することもできます。

## <a name="next-steps"></a>次の手順

ガイド付き最適化のプロファイルで使用可能なこれらの環境変数、関数、ツールの詳細については、以下を参照してください。

[ガイド付き最適化のプロファイルの環境変数](environment-variables-for-profile-guided-optimizations.md)<br/>
これらの変数は、テスト シナリオの実行時の動作を指定するために使用されます。 これらは非推奨となり、新しいリンカー オプションに置き換えられています。 このドキュメントでは、環境変数からリンカー オプションに移行する方法を示します。

[PgoAutoSweep](pgoautosweep.md)<br/>
`.pgc` ファイルのデータ キャプチャをきめ細かに制御するためにアプリに追加できる関数。

[pgosweep](pgosweep.md)<br/>
すべてのプロファイル データを `.pgc` ファイルに書き込んで、`.pgc` ファイルを閉じ、新しい `.pgc` ファイルを開くコマンドライン ユーティリティ。

[pgomgr](pgomgr.md)<br/>
1 つ以上の `.pgc` ファイルのプロファイル データを `.pgd` ファイルに追加するコマンドライン ユーティリティ。

[方法: 複数の PGO プロファイルを 1 つのプロファイルにマージする](how-to-merge-multiple-pgo-profiles-into-a-single-profile.md)<br/>
**pgomgr** の使用例。

## <a name="see-also"></a>関連項目

[追加の MSVC ビルド ツール](reference/c-cpp-build-tools.md)
